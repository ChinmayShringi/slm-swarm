version: "3.8"

services:
  worker_qwen:
    image: ollama/ollama:latest
    container_name: worker_qwen
    volumes:
      - ./models/qwen:/root/.ollama
    environment:
      - OLLAMA_HOST=0.0.0.0
    networks:
      - slm_net

  worker_llama:
    image: ollama/ollama:latest
    container_name: worker_llama
    volumes:
      - ./models/llama:/root/.ollama
    environment:
      - OLLAMA_HOST=0.0.0.0
    networks:
      - slm_net

  worker_mistral:
    image: ollama/ollama:latest
    container_name: worker_mistral
    volumes:
      - ./models/mistral:/root/.ollama
    environment:
      - OLLAMA_HOST=0.0.0.0
    networks:
      - slm_net

  judge_phi:
    image: ollama/ollama:latest
    container_name: judge_phi
    volumes:
      - ./models/phi:/root/.ollama
    environment:
      - OLLAMA_HOST=0.0.0.0
    networks:
      - slm_net

  coordinator:
    build: ./coordinator
    container_name: coordinator
    environment:
      - WORKERS=["http://worker_qwen:11434","http://worker_llama:11434","http://worker_mistral:11434"]
      - MODELS=["qwen2.5:7b-instruct","llama3.1:8b-instruct","mistral:7b-instruct"]
      - WORKER_TEMPERATURES=[0.2,0.2,0.2]
      - JUDGE=http://judge_phi:11434
      - JUDGE_MODEL=phi3:3.8b
      - CONSENSUS_METHOD=${CONSENSUS_METHOD:-cosine}
      - CONSENSUS_THRESHOLD=${CONSENSUS_THRESHOLD:-0.3}
      - SWARM_TYPE=heterogeneous
      - ADVERSARIAL_MODE=${ADVERSARIAL_MODE:-false}
      - ADVERSARIAL_WORKER_IDX=${ADVERSARIAL_WORKER_IDX:-2}
      - ADVERSARIAL_SUMMARY=${ADVERSARIAL_SUMMARY:-}
      - BIGMODEL_URL=${BIGMODEL_URL:-}
      - BIGMODEL_MODEL=${BIGMODEL_MODEL:-llama-3.1-70b-instruct}
      - BIGMODEL_TYPE=${BIGMODEL_TYPE:-openai}
      - BIGMODEL_API_KEY=${BIGMODEL_API_KEY:-}
      - GPT4_API_KEY=${GPT4_API_KEY:-}
      - CLAUDE_API_KEY=${CLAUDE_API_KEY:-}
    depends_on:
      - worker_qwen
      - worker_llama
      - worker_mistral
      - judge_phi
    ports:
      - "8000:8000"
    networks:
      - slm_net

  evaluator:
    build: ./evaluator
    container_name: evaluator
    environment:
      - COORDINATOR_URL=http://coordinator:8000
      - DATASET_PATH=${DATASET_PATH:-/app/dataset/messages.jsonl}
      - RESULTS_DIR=/app/results
    volumes:
      - ./dataset:/app/dataset
      - ./results:/app/results
    depends_on:
      - coordinator
    networks:
      - slm_net
    profiles:
      - evaluation

networks:
  slm_net:
    driver: bridge

